- LLMを利用する各ステップ（Step 3, 4, 5a）で、API呼び出しが失敗した際に指定された回数リトライする機能を追加。
- `main.py`に`--retry-step3`, `--retry-step4`, `--retry-step5a`のコマンドライン引数を追加し、各ステップのリトライ回数を個別に設定できるようにした（デフォルトは3回）。
- `step3_chunk.py`, `step4_structure.py`, `step5a_parse_answer_key.py`の各ファイルにリトライ処理のロジックを実装した。

- **Step 1: 生データ抽出の機能拡張**
  - PDFから画像データを抽出し、中間ディレクトリ (`intermediate/{pdf_stem}/images/`) にWebP形式（ロスレス圧縮）で保存する機能を追加。
  - `step1_raw_extraction.json` には、抽出した画像ブロックの情報として、保存した画像ファイルへの相対パス (`image_path`) を記録。
  - 各画像ブロックに、ページ内で最も近いテキストブロックの内容 (`associated_text`) を追加するように修正。
  - `associated_text`の計算時に、ページ番号を示す`DK...`で始まる無関係なテキストを除外するように改善。

- **Step 4c: 画像マッピングのルールベース化と改善**
  - LLMを利用する代わりに、`step1`で生成された`associated_text`を基に**ルールベースで**問題（`join_key`）と画像をマッピングするように変更。これにより、APIコストが不要になり、処理が高速化・安定化した。
  - `associated_text`内の`（A 問題20）`のような部分を抽出する正規表現を複数回にわたり改善し、複雑な文字列（複数の問題番号が混在、全角/半角スペースの混在など）にも対応できるように堅牢性を向上させた。
  - 1つの問題に複数の画像が紐づく場合、ファイル名（`...img1.webp`, `...img2.webp`）でソートし、`A`, `B`, `C`...という`image_id`を付与する機能を追加。

- **Step 5b: 正解・画像情報統合の機能拡張**
  - `step4c`の出力形式変更に伴い、`images`フィールドの統合ロジックを修正。`join_key`を基に、各問題に画像情報のリスト`[{"id": "A", "path": "..."}, ...]`を正しく付与するようにした。

- **Step 5.5: 集計情報出力の機能拡張**
  - `images`フィールドの構造変更に対応し、問題ごとの画像数を正しくカウントできるように修正。サマリーに**総画像数 (`total_images`)** を追加し、より詳細な統計情報を出力するようにした。

- **Step 6: 最終生成の機能拡張**
  - `images`フィールドの新しい構造を解釈し、最終的な画像ファイルを`{exam_id}-{join_key}-{image_id}.webp`という命名規則で`output/images/`ディレクトリに正しくコピー＆リネームするように修正。
  - 最終的なJSON内の`images`フィールドのパス情報も、新しいファイル名に更新するようにした。

- **デバッグ機能の実装**
  - `main.py`に`--debug`コマンドライン引数を追加。
  - このフラグが有効な場合のみ、各ステップで詳細な進捗ログが出力されるようにした。（現在は`step1`に実装済み）

- **解答結合キー (`join_key`) の導入**
  - `step4`の出力に、問題IDとは別に、正解情報と結合するためのキー (`join_key`) を追加。
    - 例: `id`が`tp240424-01a_01-1`の問題に、`join_key`として`A-1`を付与。
  - `step5b`では、この`join_key`を使って問題と正解をマッピングするように修正し、ロジックの堅牢性を向上させた。

- **不具合修正**
  - `main.py`の`--steps`引数のデフォルト値に`5b`などが含まれておらず、デフォルト実行時に処理がスキップされる問題を修正。
  - `main.py`において、異なるファイル（例: `...a_01.pdf`と`...seitou.pdf`）から共通の試験ID（例: `tp240424-01`）を正しく抽出できていなかった問題を正規表現の修正により解決。
  - `step5a`の出力パスが他のステップと不整合だったため、入力ファイルと同じディレクトリに出力するように修正。
  - `step4`で`join_key`を生成するロジックの不具合を複数回にわたり修正し、期待通りのキーが生成されるようにした。
  - `step5b_integrate_answers.py`で`UnboundLocalError`が発生する問題を修正。
  - `step1_extract.py`で`unsupported colorspace for 'png'`エラーが発生する問題を修正し、`png`を介さずに直接WebPロスレス圧縮で保存するように変更。
  - `step4c_map_images.py`で`AttributeError: 'list' object has no attribute 'get'`エラーが発生する問題を修正し、`raw_data`を直接ページのリストとして扱うように変更。
    - `step1_extract.py`において、画像とテキストの関連付けロジックで発生していた`float`と`tuple`の比較エラーを修正。

- **Step 7: LLMによる問題解答機能の実装**
  - `step6`で生成された最終的なJSONデータを基に、LLMが問題を解く`step7`を新たに追加。
  - **プロンプト設計:**
    - `src/steps/step7_prompt.txt` にプロンプトテンプレートを配置。
    - LLMが日本の医師として振る舞うよう指示。
    - 問題文、選択肢、および関連画像を提示。
    - 正解情報はプロンプトに含まないように、`answer`フィールドを意図的に除外。
    - 複数画像がある場合はアルファベット順 (`A`, `B`, `C`...) であることを明記。
    - 解答、根拠、自信度、関連領域をJSON形式で出力するように厳密に指示。
  - **実装 (`src/steps/step7_solve_problem.py`):**
    - `output/json`から最終JSONファイルを読み込み、`output/images`から関連画像を読み込む。
    - LLMへのAPI呼び出しには、他のステップと同様のリトライ機能 (`--retry-step7`) と待機時間 (`--rate-limit-wait`) を実装。
    - 同じ問題を複数回解かせるための `--num-runs` 引数を追加し、解答の再現性や揺らぎを検証可能にした。
    - 結果は `output/step7_solved/{exam_id}.jsonl` にJSONL形式で逐次保存。処理の中断に備え、問題ID、実行回数、タイムスタンプを記録する。
  - **`main.py`の更新:**
    - `step7`を独立したステップとして実行できるように修正。`--steps`引数に`7`が指定された場合のみ実行される。
    - `step7`に関連するコマンドライン引数 (`--retry-step7`, `--num-runs`) を追加。
