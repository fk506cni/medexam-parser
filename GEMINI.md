- **コメント・Docstringの英語併記**
  - `README.md`および主要なPythonスクリプト（`src/main.py`, `src/steps/*.py`）内のコメントとDocstringに日本語と英語を併記し、可読性と国際化を向上させた。

- LLMを利用する各ステップ（Step 3, 4, 5a）で、API呼び出しが失敗した際に指定された回数リトライする機能を追加。
- `main.py`に`--retry-step3`, `--retry-step4`, `--retry-step5a`のコマンドライン引数を追加し、各ステップのリトライ回数を個別に設定できるようにした（デフォルトは3回）。
- `step3_chunk.py`, `step4_structure.py`, `step5a_parse_answer_key.py`の各ファイルにリトライ処理のロジックを実装した。

- **Step 1: 生データ抽出の機能拡張**
  - PDFから画像データを抽出し、中間ディレクトリ (`intermediate/{pdf_stem}/images/`) にWebP形式（ロスレス圧縮）で保存する機能を追加。
  - `step1_raw_extraction.json` には、抽出した画像ブロックの情報として、保存した画像ファイルへの相対パス (`image_path`) を記録。
  - 各画像ブロックに、ページ内で最も近いテキストブロックの内容 (`associated_text`) を追加するように修正。
  - `associated_text`の計算時に、ページ番号を示す`DK...`で始まる無関係なテキストを除外するように改善。

- **Step 4c: 画像マッピングのルールベース化と改善**
  - LLMを利用する代わりに、`step1`で生成された`associated_text`を基に**ルールベースで**問題（`join_key`）と画像をマッピングするように変更。これにより、APIコストが不要になり、処理が高速化・安定化した。
  - `associated_text`内の`（A 問題20）`のような部分を抽出する正規表現を複数回にわたり改善し、複雑な文字列（複数の問題番号が混在、全角/半角スペースの混在など）にも対応できるように堅牢性を向上させた。
  - 1つの問題に複数の画像が紐づく場合、ファイル名（`...img1.webp`, `...img2.webp`）でソートし、`A`, `B`, `C`...という`image_id`を付与する機能を追加。

- **Step 5b: 正解・画像情報統合の機能拡張**
  - `step4c`の出力形式変更に伴い、`images`フィールドの統合ロジックを修正。`join_key`を基に、各問題に画像情報のリスト`[{"id": "A", "path": "..."}, ...]`を正しく付与するようにした。

- **Step 5.5: 集計情報出力の機能拡張**
  - `images`フィールドの構造変更に対応し、問題ごとの画像数を正しくカウントできるように修正。サマリーに**総画像数 (`total_images`)** を追加し、より詳細な統計情報を出力するようにした。

- **Step 6: 最終生成の機能拡張**
  - `images`フィールドの新しい構造を解釈し、最終的な画像ファイルを`{exam_id}-{join_key}-{image_id}.webp`という命名規則で`output/images/`ディレクトリに正しくコピー＆リネームするように修正。
  - 最終的なJSON内の`images`フィールドのパス情報も、新しいファイル名に更新するようにした。

- **デバッグ機能の実装**
  - `main.py`に`--debug`コマンドライン引数を追加。
  - このフラグが有効な場合のみ、各ステップで詳細な進捗ログが出力されるようにした。（現在は`step1`に実装済み）

- **解答結合キー (`join_key`) の導入**
  - `step4`の出力に、問題IDとは別に、正解情報と結合するためのキー (`join_key`) を追加。
    - 例: `id`が`tp240424-01a_01-1`の問題に、`join_key`として`A-1`を付与。
  - `step5b`では、この`join_key`を使って問題と正解をマッピングするように修正し、ロジックの堅牢性を向上させた。

- **不具合修正**
  - `main.py`の`--steps`引数のデフォルト値に`5b`などが含まれておらず、デフォルト実行時に処理がスキップされる問題を修正。
  - `main.py`において、異なるファイル（例: `...a_01.pdf`と`...seitou.pdf`）から共通の試験ID（例: `tp240424-01`）を正しく抽出できていなかった問題を正規表現の修正により解決。
  - `step5a`の出力パスが他のステップと不整合だったため、入力ファイルと同じディレクトリに出力するように修正。
  - `step4`で`join_key`を生成するロジックの不具合を複数回にわたり修正し、期待通りのキーが生成されるようにした。
  - `step5b_integrate_answers.py`で`UnboundLocalError`が発生する問題を修正。
  - `step1_extract.py`で`unsupported colorspace for 'png'`エラーが発生する問題を修正し、`png`を介さずに直接WebPロスレス圧縮で保存するように変更。
  - `step4c_map_images.py`で`AttributeError: 'list' object has no attribute 'get'`エラーが発生する問題を修正し、`raw_data`を直接ページのリストとして扱うように変更。
    - `step1_extract.py`において、画像とテキストの関連付けロジックで発生していた`float`と`tuple`の比較エラーを修正。

- **連続問題対応のための改修（進行中）**
  - **最終的なデータ構造の再定義:**
    - 一問一答問題と連続問題を区別するため、最終出力JSONの構造を再定義。
    - トップレベルに `problem_format` (`single` or `consecutive`) を導入。
    - `single` の場合、既存の問題オブジェクトは `problem` キー以下にネストされる。
    - `consecutive` の場合、共通の症例提示文 (`case_presentation`) と、それに紐づく設問リスト (`sub_questions`) を持つ構造を定義。
    - 症例提示文自体が画像と紐づくように、トップレベルに `join_key` を追加。
    - `step6_finalize.py` を修正し、まず一問一答形式の問題がこの新しい構造で出力されるように対応。
  - **Step 3b: 連続問題チャンク抽出機能の実装:**
    - 症例提示の後に複数の問題が続くパターン（例：「次の文を読み、60～62の問いに答えよ。」）に対応するため、新しい処理ステップ `step3b` を追加。
    - `src/steps/step3b_chunk_consecutive.py` を新規作成し、ルールベースで連続問題ブロックを抽出するようにした。
    - `main.py` を修正し、`step3b` を実行フローに統合。
    - **不具合修正:** 当初、`re.sub`に渡す文字列リテラル内の不正な改行が原因で `SyntaxError` が頻発。最終的に `write_file` でファイル全体を上書きすることで問題を解決。
  - **Step 4b: 連続問題の構造化機能の実装:**
    - `step3b`で切り出したチャンクを構造化するため、`step4b`を新たに追加。
    - LLMへの指示を記述した `src/steps/step4b_prompt.txt` を作成。
    - 構造化処理を行う `src/steps/step4b_structure_consecutive.py` を作成。
    - `main.py` を修正し、`step4b` を実行フローに統合。
    - **不具合修正:** 当初、`google.generativeai`ライブラリの`Client`クラスを誤ってインポートしていたため`ImportError`が発生。プロジェクト内の他のステップと使用方法を統一し、`genai.GenerativeModel` を使うように修正して解決。
  - **Step 5b: 統合処理の改修 (進行中):**
    - 一問一答形式 (`step4`の出力) と連続問題形式 (`step4b`の出力) の両方を扱えるように `step5b_integrate_answers.py` の改修に着手。
    - **TODO:** 現在、`step5b`の改修は完了していない。次回は、このファイルの修正から再開する。

- **連続問題の画像マッピング機能(step4d)の追加**
  - 連続問題の症例提示文に紐づく画像をマッピングするため、新しいステップ`step4d`を追加。
  - `src/steps/step4d_map_consecutive_images.py`を新規作成。このスクリプトは`step1`の`associated_text`と`step3b`のチャンク情報を基に、ルールベースで症例提示文の`join_key`（例: `C-60-62`）と画像を紐付ける。
  - `main.py`を修正し、`step4d`を実行フローに統合。画像PDF(`_02.pdf`)の処理時に`step4d`が実行されるようにした。
  - `join_key`生成ロジックの不具合を修正し、ファイル名から正しくブロック文字（例: `C`）を抽出できるようにした。

- **統合処理(step5b)の大幅な改修**
  - `main.py`を修正し、`step5b`の実行時に、その試験IDに関連する全ての中間ファイル（`step4`, `step4b`, `step4c`, `step4d`, `step5a`の出力）のパスを収集して渡すように変更。
  - `step5b`単独実行時でも、中間ファイルをファイルシステムから探索して実行できるようにフォールバック処理を追加。
  - `src/steps/step5b_integrate_answers.py`を全面的に書き直し、以下の機能に対応。
    - 一問一答形式(`single`)と連続問題形式(`consecutive`)の両方のデータ構造を正しく解釈。
    - `step4c`と`step4d`から得られた複数の画像マッピング情報を単一の辞書にマージ。
    - `problem_format`に応じて、適切な階層（`problem`オブジェクト、`case_presentation`、`sub_questions`）に正解・画像情報を注入。
    - **重複排除機能:** `step3`で誤って抽出された連続問題（一問一答として扱われている）を、`step3b`の連続問題ブロックに含まれる問題番号を基に検出し、最終的なJSONから除外する機能を追加。
    - **ソート機能:** 最終的な問題リストを、`join_key`のアルファベットと問題番号の昇順でソートする機能を追加。

- **不具合修正と機能改善 (2025/08/08)**
  - **Step 3: LLM応答の安定化**
    - `step3_chunk.py`において、LLMからの応答が不正なJSONであったり、JSON構造を抽出できなかったりした場合に、API呼び出しをリトライするように修正。これにより、一時的なモデルの不調によるエラーを吸収し、処理の成功率を向上させた。
    - `step3_prompt.txt`の指示をより明確化し、LLMが途中で出力を打ち切ることなく、完全なJSONを返すように促す一文を追加。
  - **Step 5.5: 集計機能の連続問題対応**
    - `step5_5_create_summary.py`を修正し、`step5b`から渡される新しいデータ構造（`problem_format`キーを持つ）を正しく解釈できるようにした。
    - 一問一答形式と連続問題形式（`sub_questions`を持つ）の両方を走査し、総問題数、画像数などを正確にカウントするようにロジックを更新。
    - サマリーに`problem_format_counts`を追加し、一問一答と連続問題がそれぞれいくつ含まれているかの分布を出力するようにした。
  - **Step 5b: 出力順序の保証**
    - `step5b_integrate_answers.py`に、より厳密なソートロジックを実装。
    - `join_key`（例: `A-1`, `C-60`）を基に、まずアルファベット順、次に問題番号順でソートすることで、最終的なJSONの出力順が実際の試験の問題冊子の順序と一致するようにした。
  - **main.pyのパス修正**
    - `step5b`の出力ファイル名が`step5b_integrated.json`に変更されたにもかかわらず、後続の`step5.5`と`step6`が古いファイル名を参照していたため発生していた`FileNotFoundError`を修正。
  - **その他の不具合修正**
    - `step5_5_create_summary.py`で、マッチしなかった正解キーのリストを処理する際に、データ形式の不一致が原因で`AttributeError`が発生する問題を修正。
    - `step5b`でマッチしなかった正解キーを保存する際のフォーマットを修正。

- **Step 7: LLM問題解答機能の連続問題対応 (2025/08/08)**
  - **プロンプトの追加と修正:**
    - 連続問題専用のプロンプト `src/steps/step7_consecutive_prompt.txt` を新規作成。
    - 既存の一問一答用プロンプト `src/steps/step7_prompt.txt` と指示形式・スタイルを統一し、LLMへの指示の一貫性を向上。
    - 両プロンプトともに、LLMの応答形式を「JSONオブジェクトの配列」に統一。
  - **`step7_solve_problem.py` の改修:**
    - `problem_format` (`single` or `consecutive`) を読み取り、使用するプロンプトと処理を動的に切り替えるように修正。
    - 連続問題の解答（JSON配列）を正しくパースし、各設問の解答を個別の行としてJSONLファイルに保存するようにした。
    - LLMに問題を提示する前に、問題データから `answer` キーを確実に削除する処理を、連続問題のケースにも適用し、正解が漏洩しないように修正。

- **Step 6: 最終生成機能の連続問題対応 (2025/08/08)**
  - `step6_finalize.py` を全面的に改修し、`step5b`が出力する新しいデータ構造（`problem_format`キーを持つ）に完全対応。
  - 一問一答問題（`problem`キー以下）と連続問題（`case_presentation`および`sub_questions`内）の両方に含まれる画像リストを再帰的に処理。
  - 全ての画像を`output/images`にコピーし、JSON内のパス情報を正しく更新するロジックを実装。これにより、画像が出力されない不具合を修正。
