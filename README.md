# **medexam-parser: 医師国家試験PDFデータ化プロジェクト**

## **はじめに**

このプロジェクトは、厚生労働省が公開している医師国家試験の問題PDFを解析し、機械可読性の高いJSON形式のデータセットと、問題に付随する画像を抽出することを目的としています。生成されたデータは、学習アプリ、統計分析、研究など、様々な用途での活用が期待されます。

## **ライセンス**

このリポジトリに含まれるソースコードは [GNU General Public License v3.0](https://www.gnu.org/licenses/gpl-3.0.html) のもとで公開されています。

【重要】ライセンスの適用範囲について  
本ライセンスは、このリポジトリに含まれるソースコードおよび関連するドキュメントのみに適用されます。  
利用者がinput/ディレクトリに配置する元のPDFファイル、および本ツールによって生成される\*\*JSONデータや画像ファイル（output/ディレクトリ内の成果物）\*\*は、GPL v3.0の適用範囲外です。これらの著作権は元の権利者に帰属します。成果物の利用にあたっては、元のPDFの利用規約や著作権法を遵守してください。

## **想定される技術スタック**

* **プログラミング言語:** Python 3.9+  
* **実行環境:** Docker, Docker Compose  
* **主要ライブラリ:**  
  * PyMuPDF (fitz): PDFからのテキスト、画像、座標情報の抽出  
  * Pillow: 画像処理、WebP形式への変換  
  * python-dotenv: 環境変数の管理  
  * LLM API Client (e.g., openai, google-generativeai): LLMとの連携  
* **データフォーマット:** JSON, WebP

## **概要**

medexam-parserは、指定された年度の医師国家試験問題PDF（問題冊子、別冊、正答値表）をインプットとして受け取ります。PythonスクリプトがこれらのPDFを解析し、問題文、選択肢、画像、正解といった情報を構造化されたデータに変換します。

**主な特徴:**

* **Dockerによる環境構築:** 実行環境の違いによる問題をなくし、誰でも簡単に実行できます。  
* **構造化データ出力:** 全ての問題は、後続処理で扱いやすい統一されたJSON形式で出力されます。  
* **画像抽出と最適化:** 問題に関連する画像は自動で抽出され、Webで扱いやすいWebP形式に変換・保存されます。  
* **ハイブリッド解析:** 高速なルールベースの解析を基本とし、複雑な問題レイアウトにはLLM（大規模言語モデル）を利用するハイブリッドアプローチを想定しています。  
* **ステップごとの中間ファイル:** 開発やデバッグを容易にするため、処理の各段階で中間ファイルを出力します。

## **プロジェクトファイル構成**

.  
├── docker-compose.yml     \# Dockerコンテナの起動設定  
├── Dockerfile             \# Dockerコンテナの設計図  
├── requirements.txt       \# Pythonの依存ライブラリ  
├── .env.example           \# 環境変数設定のテンプレート  
├── src/  
│   └── main.py            \# メインの処理スクリプト  
│  
├── input/                 \# ここに処理対象のPDFを配置する  
│   ├── 118a.pdf  
│   ├── 118d.pdf  
│   └── ...  
│  
├── output/                \# 処理結果がここに生成される  
│   ├── json/  
│   │   └── 118.json  
│   └── images/  
│       ├── 118-A-1-1.webp  
│       └── ...  
│  
└── intermediate/          \# 各処理ステップの中間ファイルがここに保存される  
    └── 118a/  
        ├── step1\_raw\_extraction.json  
        ├── step2\_reordered\_text.txt  
        └── ...

## **処理フロー**

データ生成は以下のフローで行われます。正規表現で対応できない複雑なケースでは、LLMによる解析をフォールバックとして利用します。

graph TD  
    A\[1. PDF配置\] \--\> B(2. ファイル名解析);  
    B \--\> C{Step 1: 生データ抽出};  
    C \--\> D{Step 2: テキスト順序再構成};  
    D \--\> E{Step 3: 問題チャンク分割};  
    E \-- ルールベースで失敗 \--\> E\_LLM\[LLMによる分割支援\];  
    E\_LLM \--\> F;  
    E \-- ルールベースで成功 \--\> F;  
    F{Step 4: 構造化};  
    F \-- ルールベースで失敗 \--\> G\[LLMによる構造化\];  
    G \--\> H\[構造化データ\];  
    F \-- ルールベースで成功 \--\> H;  
    I\[正答値表PDF\] \--\> J{Step 5: 正解情報統合};  
    H \--\> J;  
    J \--\> K{Step 5.5: 集計情報出力};  
    K \--\> L{Step 6: 最終生成};  
    L \--\> M\[JSONファイル出力\];  
    L \--\> N\[画像ファイル出力\];

## **実装ステップと現状**

* \[ \] **Step 1: Raw Extraction (生データ抽出)**: PDFからテキストと画像の座標情報を抽出する。  
* \[ \] **Step 2: Text Reordering (テキスト順序再構成)**: 2段組レイアウトを解析し、テキストを正しい順序に並べ替える。  
* \[ \] **Step 3: Problem Chunking (問題チャンク分割)**: テキストを問題ごとに分割する。OCRの揺れや複雑なレイアウトに対応するため、正規表現 (^問題\\s\*\\\\d+)での分割を試み、失敗した場合はLLMにテキスト全体を渡して分割を依頼する。  
* \[ \] **Step 4: Structure Parsing (構造化)**: ルールベースとLLMを使い、各問題をJSONオブジェクトに変換する。  
* \[ \] **Step 5: Answer Integration (正解情報の統合)**: 正答値表を読み込み、各問題に正解データを結合する。  
* \[ \] **Step 5.5: Summary Output (集計情報出力)**: 各PDFファイルごとの問題数、問題タイプの内訳、画像数などの統計情報を中間ファイルとして出力し、検証を容易にする。  
* \[ \] **Step 6: Finalization (最終生成)**: 全てのデータを統合し、最終的なJSONと画像ファイルを出力する。

## **実行手順**

#### **1\. リポジトリのクローン**

git clone https://github.com/your-username/medexam-parser.git  
cd medexam-parser

#### **2\. 環境変数の設定**

LLMを利用するためにAPIキーを設定します。.env.exampleをコピーして.envファイルを作成してください。

cp .env.example .env

その後、.envファイルを開き、お使いのLLMのAPIキーを記述します。

\# 例: OpenAI API Key  
OPENAI\_API\_KEY="your\_api\_key\_here"

#### **3\. 入力PDFの配置**

処理したい年度の医師国家試験PDF一式をinput/ディレクトリに配置します。

* **命名規則:** {回数}{ブロック識別子}.pdf  
* **例:** 118a.pdf, 118d.pdf, 118s.pdf

#### **4\. Dockerコンテナのビルドと実行**

docker-compose up \--build

処理が完了すると、output/ディレクトリに成果物が生成されます。

## **生成される産物の例**

#### **JSONデータ (output/json/{exam\_id}.json)**

**禁忌肢を含む選択式問題の例:**

{  
  "id": "118-X-99",  
  "question\_type": "multiple\_choice",  
  "text": "（問題文）",  
  "images": \[\],  
  "choices": \[  
    { "id": "1", "text": "選択肢1" },  
    { "id": "2", "text": "選択肢2" },  
    { "id": "3", "text": "選択肢3" },  
    { "id": "4", "text": "選択肢4" }  
  \],  
  "answer": {  
    "choices": \["1", "4"\],  
    "forbidden\_choices": \["2"\]  
  }  
}

**Note:** 禁忌肢の情報は、公式に公開されている正答値表には通常含まれていません。この情報を付与するには、別途定義された禁忌肢リストなどを読み込ませる必要があります。

**数字入力問題の例:**

{  
  "id": "118-D-75",  
  "question\_type": "numeric\_float",  
  "text": "生後1時間の男児...1時間あたりの10%ブドウ糖液投与量を求めよ。...",  
  "images": \[\],  
  "choices": null,  
  "answer": {  
    "value": 9.6,  
    "unit": "mL/時間"  
  }  
}

#### **画像データ (output/images/)**

* 118-D-16-1.webp (第118回 D問題16番の1枚目の画像)

## **今後の課題・展望**

* **対応年度の拡大:** 過去の年度の試験問題PDFにも対応できるよう、パーサーの堅牢性を向上させる。  
* **Web UIの開発:** PDFをアップロードし、ブラウザ上で結果を確認・編集できるインターフェースを構築する。  
* **精度評価:** ルールベースとLLMによる解析結果の精度を定量的に評価し、比較する仕組みを導入する。  
* **パフォーマンス最適化:** 大量のPDFを高速に処理するための並列処理やキャッシュ機構を検討する。

## **貢献の方法 (Contributing)**

バグ報告、機能追加の提案、プルリクエストはGitHubのIssuesからお願いします。
